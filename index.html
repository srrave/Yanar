<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="theme-color" content="#0a0a0f"/>
<meta name="description" content="YANAR ‚Äì Your Academic Network & Resource"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="YANAR"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<title>YANAR</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet"/>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#0a0a0f;--bg2:#111118;--bg3:#1a1a24;--card:#16161f;
  --border:#2a2a3a;--accent:#6c63ff;--accent2:#ff6584;--accent3:#43e97b;
  --text:#f0f0f8;--text2:#9999b3;--text3:#555570;
  --radius:14px;--shadow:0 4px 24px rgba(0,0,0,0.4);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
h1,h2,h3,h4{font-family:'Syne',sans-serif}
button{cursor:pointer;font-family:'DM Sans',sans-serif}
input,textarea,select{font-family:'DM Sans',sans-serif}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* SETUP SCREEN */
#setup-screen{position:fixed;inset:0;z-index:2000;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column;gap:16px;text-align:center}
.setup-logo{font-family:'Syne',sans-serif;font-size:3rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.setup-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:32px;max-width:480px;width:100%}
.setup-box h2{margin-bottom:8px;font-size:1.2rem}
.setup-box p{color:var(--text2);font-size:.9rem;margin-bottom:20px;line-height:1.6}
.setup-input{width:100%;padding:11px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:.9rem;outline:none;margin-bottom:10px;transition:.2s}
.setup-input:focus{border-color:var(--accent)}
.setup-note{font-size:.8rem;color:var(--text3);background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 14px;text-align:left;line-height:1.6}
.setup-note a{color:var(--accent);text-decoration:none}

/* AUTH */
#auth-screen{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px}
.auth-box{width:100%;max-width:400px;background:var(--card);border:1px solid var(--border);border-radius:24px;padding:40px 36px;box-shadow:var(--shadow)}
.auth-logo{font-family:'Syne',sans-serif;font-size:2.8rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;margin-bottom:6px}
.auth-tagline{text-align:center;color:var(--text2);font-size:.9rem;margin-bottom:32px}
.auth-tabs{display:flex;gap:4px;background:var(--bg3);border-radius:10px;padding:4px;margin-bottom:28px}
.auth-tab{flex:1;padding:8px;border:none;background:transparent;color:var(--text2);border-radius:8px;font-size:.9rem;font-weight:500;transition:.2s}
.auth-tab.active{background:var(--accent);color:#fff}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:.8rem;color:var(--text2);margin-bottom:6px;font-weight:500;letter-spacing:.5px;text-transform:uppercase}
.form-group input,.form-group select{width:100%;padding:12px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:.95rem;outline:none;transition:.2s;appearance:none}
.form-group input:focus,.form-group select:focus{border-color:var(--accent)}
.btn-primary{width:100%;padding:13px;background:linear-gradient(135deg,var(--accent),#9b59b6);border:none;border-radius:10px;color:#fff;font-size:1rem;font-weight:600;font-family:'Syne',sans-serif;transition:.2s}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(108,99,255,.4)}
.btn-primary:disabled{opacity:.6;transform:none;cursor:not-allowed}
.auth-error{color:var(--accent2);font-size:.85rem;margin-top:12px;text-align:center;min-height:20px}

/* APP */
#app{display:none;flex-direction:column;min-height:100vh}
#app.active{display:flex}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:100;background:rgba(10,10,15,.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:12px}
.topbar-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.4rem;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;flex-shrink:0}
.search-bar{flex:1;position:relative}
.search-bar input{width:100%;padding:9px 14px 9px 38px;background:var(--bg3);border:1px solid var(--border);border-radius:50px;color:var(--text);font-size:.9rem;outline:none;transition:.2s}
.search-bar input:focus{border-color:var(--accent)}
.search-bar svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.5}
.topbar-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;flex-shrink:0;cursor:pointer;font-family:'Syne',sans-serif}

/* FILTER BANNER */
.filter-banner{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 16px;overflow-x:auto;display:flex;align-items:center;gap:8px;white-space:nowrap}
.filter-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:50px;background:var(--bg3);border:1px solid var(--accent);color:var(--accent);font-size:.8rem;flex-shrink:0}
.filter-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:50px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-size:.8rem;cursor:pointer;flex-shrink:0;transition:.2s}
.filter-btn:hover{border-color:var(--accent);color:var(--accent)}

/* LAYOUT */
.main-layout{display:flex;flex:1;max-width:1100px;margin:0 auto;width:100%;padding:20px 16px;gap:20px}
.feed{flex:1;min-width:0}
.sidebar{width:280px;flex-shrink:0}

/* POST CARD */
.post-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px;transition:.2s}
.post-card:hover{border-color:var(--accent)55}
.post-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.post-avatar{width:38px;height:38px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;font-family:'Syne',sans-serif}
.post-meta{flex:1;min-width:0}
.post-author{font-weight:600;font-size:.9rem}
.post-info{font-size:.75rem;color:var(--text2);margin-top:2px}
.post-badge{padding:3px 10px;border-radius:50px;font-size:.72rem;font-weight:600;font-family:'Syne',sans-serif;letter-spacing:.3px}
.badge-question{background:#ff658422;color:var(--accent2)}
.badge-info{background:#6c63ff22;color:var(--accent)}
.badge-opportunity{background:#43e97b22;color:var(--accent3)}
.badge-resource{background:#f7971e22;color:#f7971e}
.post-title{font-size:1rem;font-weight:600;margin-bottom:8px;line-height:1.4}
.post-body{color:var(--text2);font-size:.9rem;line-height:1.6;margin-bottom:12px;white-space:pre-wrap}
.post-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.post-tag{padding:3px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:50px;font-size:.75rem;color:var(--text2);cursor:pointer}
.post-target{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--text3);margin-bottom:10px;flex-wrap:wrap}
.post-target span{background:var(--bg3);padding:2px 8px;border-radius:4px}
.post-media{border-radius:10px;overflow:hidden;margin-bottom:12px;background:var(--bg3);border:1px solid var(--border);padding:12px;display:flex;align-items:center;gap:10px;color:var(--text2);font-size:.85rem}
.post-media img{max-width:100%;border-radius:8px;display:block}
.post-actions{display:flex;align-items:center;gap:16px;padding-top:12px;border-top:1px solid var(--border)}
.post-action{display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--text2);font-size:.85rem;transition:.2s;padding:4px 8px;border-radius:8px}
.post-action:hover{color:var(--text);background:var(--bg3)}
.post-action.liked{color:var(--accent2)}
.post-action.liked svg{fill:var(--accent2)}

/* COMMENTS */
.comments-section{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
.comment{display:flex;gap:10px;margin-bottom:14px}
.comment-avatar{width:30px;height:30px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;font-family:'Syne',sans-serif}
.comment-content{flex:1}
.comment-author{font-size:.82rem;font-weight:600}
.comment-text{font-size:.85rem;color:var(--text2);margin-top:3px;line-height:1.5}
.comment-actions{display:flex;gap:12px;margin-top:6px}
.comment-action{background:none;border:none;color:var(--text3);font-size:.75rem;transition:.2s;cursor:pointer}
.comment-action:hover{color:var(--text2)}
.comment-input-row{display:flex;gap:10px;align-items:center;margin-top:12px}
.comment-input-row input{flex:1;padding:8px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:50px;color:var(--text);font-size:.85rem;outline:none;transition:.2s}
.comment-input-row input:focus{border-color:var(--accent)}
.comment-send{padding:8px 14px;background:var(--accent);border:none;border-radius:50px;color:#fff;font-size:.82rem;font-weight:600;transition:.2s}
.comment-send:hover{background:#7c73ff}
.nested-comments{margin-left:40px;border-left:2px solid var(--border);padding-left:12px;margin-top:8px}

/* FAB */
.fab{position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(108,99,255,.5);font-size:1.5rem;z-index:50;transition:.2s}
.fab:hover{transform:scale(1.08)}

/* BOTTOM NAV */
.bottom-nav{position:sticky;bottom:0;background:rgba(10,10,15,.95);backdrop-filter:blur(16px);border-top:1px solid var(--border);display:flex;z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 0;background:none;border:none;color:var(--text3);font-size:.65rem;gap:4px;transition:.2s;font-family:'DM Sans',sans-serif}
.nav-item.active{color:var(--accent)}
.nav-item svg{width:22px;height:22px}

/* SIDEBAR */
.sidebar-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:16px}
.sidebar-card h3{font-size:.85rem;color:var(--text2);margin-bottom:14px;text-transform:uppercase;letter-spacing:.8px}

/* MODALS */
.modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center}
.modal-box{width:100%;max-width:520px;background:var(--card);border-radius:24px 24px 0 0;border:1px solid var(--border);border-bottom:none;padding:24px;max-height:85vh;overflow-y:auto}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px}
.modal-title{font-size:1.1rem;font-weight:700;margin-bottom:20px}
.select-group{margin-bottom:16px}
.select-group label{display:block;font-size:.8rem;color:var(--text2);margin-bottom:6px;font-weight:500;text-transform:uppercase;letter-spacing:.5px}
.select-group select{width:100%;padding:11px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:.9rem;outline:none;appearance:none;cursor:pointer}
.select-group select:focus{border-color:var(--accent)}
.saved-combo-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:.2s}
.saved-combo-item:hover{border-color:var(--accent)}
.modal-actions{display:flex;gap:10px;margin-top:20px}
.btn-secondary{flex:1;padding:11px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:.9rem;font-weight:600;transition:.2s}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
.modal-actions .btn-primary{flex:1;padding:11px;font-size:.9rem;width:auto}

/* CREATE MODAL */
.create-modal{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center}
.create-box{width:100%;max-width:600px;background:var(--card);border-radius:24px 24px 0 0;border:1px solid var(--border);border-bottom:none;padding:24px;max-height:90vh;overflow-y:auto}
.post-type-selector{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap}
.type-btn{padding:6px 14px;border-radius:50px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:.82rem;font-weight:600;transition:.2s}
.type-btn.active-q{background:#ff658422;border-color:var(--accent2);color:var(--accent2)}
.type-btn.active-i{background:#6c63ff22;border-color:var(--accent);color:var(--accent)}
.type-btn.active-o{background:#43e97b22;border-color:var(--accent3);color:var(--accent3)}
.type-btn.active-r{background:#f7971e22;border-color:#f7971e;color:#f7971e}
.create-input{width:100%;padding:11px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:.9rem;outline:none;transition:.2s;margin-bottom:12px}
.create-input:focus{border-color:var(--accent)}
textarea.create-input{resize:none;height:100px;line-height:1.6}
.upload-area{border:2px dashed var(--border);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:.2s;margin-bottom:12px}
.upload-area:hover{border-color:var(--accent);background:var(--accent)08}
.upload-area p{color:var(--text2);font-size:.85rem;margin-top:6px}
.audience-row{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.audience-row label{font-size:.82rem;color:var(--text2);font-weight:500}
.audience-chip{padding:4px 12px;border-radius:50px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:.78rem;cursor:pointer;transition:.2s}
.audience-chip.selected{background:var(--accent);border-color:var(--accent);color:#fff}
.char-counter{font-size:.75rem;color:var(--text3);text-align:right;margin-top:-8px;margin-bottom:12px}

/* PROFILE */
.profile-header{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:16px;text-align:center}
.profile-avatar-big{width:72px;height:72px;border-radius:50%;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:700;font-family:'Syne',sans-serif}
.profile-username{font-size:1.4rem;font-weight:800;margin-bottom:4px}
.profile-college{font-size:.85rem;color:var(--text2)}
.profile-stats{display:flex;justify-content:center;gap:32px;margin-top:18px}
.profile-stat{text-align:center}
.profile-stat-num{font-size:1.3rem;font-weight:800;color:var(--accent)}
.profile-stat-label{font-size:.75rem;color:var(--text2);margin-top:2px}

/* LOADING */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;gap:10px;color:var(--text2)}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.empty-state{text-align:center;padding:60px 20px;color:var(--text2)}
.empty-state h3{font-size:1rem;margin-bottom:8px;color:var(--text)}
.empty-state p{font-size:.85rem}

.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--accent);color:var(--text);padding:10px 20px;border-radius:50px;font-size:.85rem;z-index:500;opacity:0;transition:.3s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1}

@media(max-width:768px){.sidebar{display:none}.main-layout{padding:12px;gap:0}}
</style>
</head>
<body>

<!-- SETUP SCREEN (shown only if Supabase not configured) -->
<div id="setup-screen" style="display:none">
  <div class="setup-logo">YANAR</div>
  <div class="setup-box">
    <h2>üîß Connect Your Database</h2>
    <p>YANAR needs a free Supabase project to store posts, users, and comments. This takes 2 minutes to set up.</p>
    <input class="setup-input" id="setup-url" placeholder="Supabase Project URL (https://xxxx.supabase.co)"/>
    <input class="setup-input" id="setup-key" placeholder="Supabase Anon/Public Key"/>
    <button class="btn-primary" onclick="saveSupabaseConfig()" style="margin-bottom:16px">Connect & Launch YANAR</button>
    <div class="setup-note">
      <strong>How to get these:</strong><br/>
      1. Go to <a href="https://supabase.com" target="_blank">supabase.com</a> ‚Üí New Project (free)<br/>
      2. Settings ‚Üí API ‚Üí copy <em>Project URL</em> and <em>anon public</em> key<br/>
      3. Run the SQL from <code>supabase-setup.sql</code> in the SQL Editor<br/>
      4. Paste them above and click Connect!
    </div>
  </div>
</div>

<!-- AUTH SCREEN -->
<div id="auth-screen" style="display:none">
  <div class="auth-box">
    <div class="auth-logo">YANAR</div>
    <p class="auth-tagline">Your Academic Network & Resource</p>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
    </div>
    <div id="login-form">
      <div class="form-group"><label>Username</label><input type="text" id="login-username" placeholder="Your username"/></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-password" placeholder="Your password" onkeydown="if(event.key==='Enter')doLogin()"/></div>
      <button class="btn-primary" id="login-btn" onclick="doLogin()">Sign In</button>
      <p class="auth-error" id="login-error"></p>
    </div>
    <div id="register-form" style="display:none">
      <div class="form-group"><label>Username</label><input type="text" id="reg-username" placeholder="Choose a username"/></div>
      <div class="form-group"><label>Full Name (optional)</label><input type="text" id="reg-name" placeholder="Your display name"/></div>
      <div class="form-group"><label>Password</label><input type="password" id="reg-password" placeholder="Min 6 characters"/></div>
      <div class="form-group">
        <label>University</label>
        <select id="reg-university" onchange="regUpdateColleges()"><option value="">Select University</option><option value="Anna University">Anna University</option></select>
      </div>
      <div class="form-group"><label>College</label><select id="reg-college" onchange="regUpdateBranches()"><option value="">Select College</option></select></div>
      <div class="form-group"><label>Branch / Department</label><select id="reg-branch"><option value="">Select Branch</option></select></div>
      <div class="form-group">
        <label>Year</label>
        <select id="reg-year"><option value="">Select Year</option><option value="1">1st Year</option><option value="2">2nd Year</option><option value="3">3rd Year</option><option value="4">4th Year</option><option value="PG">PG</option><option value="Faculty">Faculty</option></select>
      </div>
      <button class="btn-primary" id="reg-btn" onclick="doRegister()">Create Account</button>
      <p class="auth-error" id="reg-error"></p>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <header class="topbar">
    <div class="topbar-logo">YANAR</div>
    <div class="search-bar">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="search-input" placeholder="Search posts..." oninput="debounceSearch(this.value)"/>
    </div>
    <div class="topbar-avatar" id="user-avatar" onclick="showPage('profile')">?</div>
  </header>

  <div class="filter-banner" id="filter-banner">
    <button class="filter-btn" onclick="showFilterModal()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
      Filter
    </button>
    <div id="active-filter-chips"></div>
  </div>

  <div class="main-layout">
    <main class="feed" id="feed-container"><div class="loading"><div class="spinner"></div> Loading posts‚Ä¶</div></main>
    <aside class="sidebar">
      <div class="sidebar-card">
        <h3>Your Stats</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text2);font-size:.85rem">Posts</span><span style="font-weight:700;color:var(--accent)" id="stat-posts">‚Äì</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text2);font-size:.85rem">Comments</span><span style="font-weight:700;color:var(--accent)" id="stat-comments">‚Äì</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text2);font-size:.85rem">Likes Received</span><span style="font-weight:700;color:var(--accent)" id="stat-likes">‚Äì</span></div>
        </div>
      </div>
      <div class="sidebar-card">
        <h3>Trending Tags</h3>
        <div id="trending-tags" style="display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>
      <div class="sidebar-card">
        <h3>Quick</h3>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:4px">
          <button onclick="showPage('feed')" style="background:none;border:none;color:var(--text2);font-size:.85rem;text-align:left;cursor:pointer">üè† Home Feed</button>
          <button onclick="filterByType('question')" style="background:none;border:none;color:var(--text2);font-size:.85rem;text-align:left;cursor:pointer">‚ùì Questions</button>
          <button onclick="filterByType('opportunity')" style="background:none;border:none;color:var(--text2);font-size:.85rem;text-align:left;cursor:pointer">üöÄ Opportunities</button>
          <button onclick="filterByType('resource')" style="background:none;border:none;color:var(--text2);font-size:.85rem;text-align:left;cursor:pointer">üìö Resources</button>
          <button onclick="doLogout()" style="background:none;border:none;color:var(--accent2);font-size:.85rem;text-align:left;cursor:pointer">üö™ Logout</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Profile page -->
  <div id="profile-page" style="display:none;padding:16px;max-width:700px;margin:0 auto;width:100%">
    <div class="profile-header">
      <div class="profile-avatar-big" id="profile-avatar-big"></div>
      <div class="profile-username" id="profile-username-display"></div>
      <div class="profile-college" id="profile-college-display"></div>
      <div class="profile-stats">
        <div class="profile-stat"><div class="profile-stat-num" id="ps-posts">0</div><div class="profile-stat-label">Posts</div></div>
        <div class="profile-stat"><div class="profile-stat-num" id="ps-comments">0</div><div class="profile-stat-label">Comments</div></div>
        <div class="profile-stat"><div class="profile-stat-num" id="ps-likes">0</div><div class="profile-stat-label">Likes</div></div>
      </div>
    </div>
    <div id="profile-posts"></div>
    <button onclick="showPage('feed')" style="margin-top:16px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:10px 20px;border-radius:10px;width:100%;cursor:pointer">‚Üê Back to Feed</button>
  </div>

  <button class="fab" onclick="showCreateModal()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>

  <nav class="bottom-nav">
    <button class="nav-item active" id="nav-feed" onclick="showPage('feed')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Home
    </button>
    <button class="nav-item" id="nav-questions" onclick="filterByType('question')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Q&A
    </button>
    <button class="nav-item" id="nav-opportunities" onclick="filterByType('opportunity')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>Jobs
    </button>
    <button class="nav-item" id="nav-profile" onclick="showPage('profile')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Profile
    </button>
  </nav>
</div>

<!-- FILTER MODAL -->
<div id="filter-modal" style="display:none" class="modal-overlay" onclick="if(event.target===this)closeFilterModal()">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div class="modal-title">üéØ Filter Posts</div>
    <div id="saved-combos-section" style="margin-bottom:20px">
      <div style="font-size:.8rem;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px">üìå Saved Combinations</div>
      <div id="saved-combos-list"></div>
      <button onclick="saveCurrentCombo()" style="width:100%;padding:9px;background:var(--bg3);border:1px dashed var(--border);border-radius:10px;color:var(--text2);font-size:.82rem;cursor:pointer;margin-top:4px">+ Pin Current Selection</button>
    </div>
    <div class="select-group"><label>University</label><select id="filter-university" onchange="updateCollegeOptions()"><option value="">All Universities</option><option value="Anna University">Anna University</option></select></div>
    <div class="select-group"><label>College</label><select id="filter-college" onchange="updateBranchOptions()"><option value="">All Colleges</option></select></div>
    <div class="select-group"><label>Branch / Department</label><select id="filter-branch"><option value="">All Branches</option></select></div>
    <div class="select-group"><label>Year</label><select id="filter-year"><option value="">All Years</option><option value="1">1st Year</option><option value="2">2nd Year</option><option value="3">3rd Year</option><option value="4">4th Year</option><option value="PG">PG</option><option value="Faculty">Faculty</option></select></div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="clearFilter()">Clear All</button>
      <button class="btn-primary" onclick="applyFilter()">Apply Filter</button>
    </div>
  </div>
</div>

<!-- CREATE POST MODAL -->
<div id="create-modal" style="display:none" class="create-modal" onclick="if(event.target===this)closeCreateModal()">
  <div class="create-box">
    <div class="modal-handle"></div>
    <div class="modal-title">‚ú® Create Post</div>
    <div class="post-type-selector">
      <button class="type-btn active-i" id="type-info" onclick="setPostType('info')">üì¢ Info</button>
      <button class="type-btn" id="type-question" onclick="setPostType('question')">‚ùì Question</button>
      <button class="type-btn" id="type-opportunity" onclick="setPostType('opportunity')">üöÄ Opportunity</button>
      <button class="type-btn" id="type-resource" onclick="setPostType('resource')">üìö Resource</button>
    </div>
    <input type="text" class="create-input" id="create-title" placeholder="Title / Heading‚Ä¶" maxlength="150" oninput="document.getElementById('title-chars').textContent=this.value.length"/>
    <div class="char-counter"><span id="title-chars">0</span>/150</div>
    <textarea class="create-input" id="create-body" placeholder="Share details, questions, or opportunities‚Ä¶ emojis welcome üòä" maxlength="3000" oninput="document.getElementById('body-chars').textContent=this.value.length"></textarea>
    <div class="char-counter"><span id="body-chars">0</span>/3000</div>
    <div class="upload-area" onclick="document.getElementById('file-upload').click()">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <p>Upload Photos / PDF / Brochures (max 5MB each)</p>
      <input type="file" id="file-upload" style="display:none" multiple accept="image/*,.pdf" onchange="handleFileUpload(event)"/>
    </div>
    <div id="uploaded-files" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px"></div>
    <div style="margin-bottom:16px">
      <div style="font-size:.82rem;color:var(--text2);margin-bottom:8px;font-weight:500">üì£ Who can see this?</div>
      <div id="audience-selectors" style="display:flex;flex-direction:column;gap:8px">
        <select class="create-input" id="aud-university" style="margin-bottom:0" onchange="audUpdateColleges()"><option value="">All Universities</option><option value="Anna University">Anna University</option></select>
        <select class="create-input" id="aud-college" style="margin-bottom:0" onchange="audUpdateBranches()"><option value="">All Colleges</option></select>
        <select class="create-input" id="aud-branch" style="margin-bottom:0"><option value="">All Branches</option></select>
        <select class="create-input" id="aud-year" style="margin-bottom:0"><option value="">All Years</option><option value="1">1st Year</option><option value="2">2nd Year</option><option value="3">3rd Year</option><option value="4">4th Year</option><option value="PG">PG</option></select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeCreateModal()">Cancel</button>
      <button class="btn-primary" id="submit-post-btn" onclick="submitPost()">Publish Post üöÄ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// UNIVERSITIES DATA
// ============================================================
const UNIVERSITIES = {
  "Anna University": {
    "UCE Villupuram (1013)": { branches: ["B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)","M.E. Internal Combustion Engines","B.E. Electronics and Communication Engineering","B.E. Computer Science and Engineering","B.E. Computer Science and Engineering (Cyber Security)","B.Tech. Information Technology"] },
    "UCE Tindivanam (1014)": { branches: ["B.E. Civil Engineering","B.E. Civil Engineering (Tamil Medium)","B.E. Computer Science and Engineering","B.E. Electronics and Communication Engineering","B.Tech. Information Technology","B.Tech. Electrical and Computer Engineering"] },
    "UCE Arni (1015)": { branches: ["B.E. Computer Science and Engineering","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)"] },
    "UCE Kancheepuram (1026)": { branches: ["B.E. Computer Science and Engineering","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.E. Mechanical Engineering"] },
    "AU Regional Campus ‚Äì Coimbatore (2025)": { branches: ["B.E. Computer Science and Engineering","B.E. Electronics and Communication Engineering","B.E. Electrical and Electronics Engineering","B.E. Electronics Engineering (VLSI Design and Technology)","B.E. Mechanical Engineering"] },
    "UCE Tiruchirappalli (3011)": { branches: ["B.E. Automobile Engineering","B.Tech. Bio-Technology","B.E. Civil Engineering","B.E. Civil Engineering (Tamil Medium)","B.E. Computer Science and Engineering","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.Tech. Information Technology","B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)","B.Tech. Petro Chemical Technology","B.Tech. Pharmaceutical Technology","M.E. Structural Engineering","M.E. Thermal Engineering","M.E. Manufacturing Engineering","M.E. Power Systems Engineering","M.E. Communication Systems","M.E. Computer Science and Engineering","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)","Physical Education (S&H)"] },
    "UCE Ariyalur (3016)": { branches: ["B.E. Civil Engineering","B.E. Civil Engineering (Tamil Medium)","B.E. Computer Science and Engineering","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)","Physical Education (S&H)"] },
    "UCE Thirukkuvalai (3018)": { branches: ["B.E. Civil Engineering","B.E. Civil Engineering (Tamil Medium)","B.E. Computer Science and Engineering","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)","Physical Education (S&H)"] },
    "UCE Panruti (3019)": { branches: ["B.E. Civil Engineering","B.E. Civil Engineering (Tamil Medium)","B.E. Computer Science and Engineering","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)","Physical Education (S&H)"] },
    "UCE Pattukkottai (3021)": { branches: ["B.E. Civil Engineering","B.E. Civil Engineering (Tamil Medium)","B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.E. Computer Science and Engineering","B.E. Artificial Intelligence and Machine Learning","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)","Physical Education (S&H)"] },
    "AU Regional Campus ‚Äì Tirunelveli (4020)": { branches: ["B.E. Computer Science and Engineering","B.E. Electronics and Communication Engineering","B.E. Geo Informatics Engineering","B.E. Mechanical Engineering","B.Tech. Artificial Intelligence and Data Science","MBA","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)"] },
    "UCE Nagercoil (4023)": { branches: ["B.Tech. Civil Engineering","B.Tech. Computer Science and Engineering","B.Tech. Electronics and Communication Engineering","B.Tech. Electrical and Electronics Engineering","B.Tech. Mechanical Engineering","B.Tech. Information Technology","MBA","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)"] },
    "V.O.C. College of Engineering, Thoothukudi (4024)": { branches: ["B.E. Civil Engineering","B.E. Civil Engineering (Tamil Medium)","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.E. Geo Informatics Engineering","B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)","Physical Education (S&H)"] },
    "AU Regional Campus ‚Äì Madurai (5010)": { branches: ["B.E. Civil Engineering","B.E. Computer Science and Engineering","B.E. Electronics and Communication Engineering","B.E. Mechanical Engineering","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)","Physical Education (S&H)"] },
    "UCE Ramanathapuram (5017)": { branches: ["B.E. Civil Engineering","B.E. Civil Engineering (Tamil Medium)","B.E. Computer Science and Engineering","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)","Physical Education (S&H)"] },
    "UCE Dindigul (5022)": { branches: ["B.E. Civil Engineering","B.E. Civil Engineering (Tamil Medium)","B.E. Computer Science and Engineering","B.E. Electrical and Electronics Engineering","B.E. Electronics and Communication Engineering","B.E. Mechanical Engineering","B.E. Mechanical Engineering (Tamil Medium)","Mathematics (S&H)","Physics (S&H)","Chemistry (S&H)","English (S&H)","Tamil (S&H)","Physical Education (S&H)"] }
  }
};

// ============================================================
// SUPABASE CLIENT
// ============================================================
let supabase = null;

function initSupabase(url, key) {
  supabase = window.supabase.createClient(url, key);
}

function getSavedConfig() {
  try { return JSON.parse(localStorage.getItem('yanar_sb_config')); } catch { return null; }
}

function saveSupabaseConfig() {
  const url = document.getElementById('setup-url').value.trim();
  const key = document.getElementById('setup-key').value.trim();
  if (!url || !key) { alert('Please enter both URL and key'); return; }
  localStorage.setItem('yanar_sb_config', JSON.stringify({ url, key }));
  initSupabase(url, key);
  document.getElementById('setup-screen').style.display = 'none';
  checkSession();
}

// ============================================================
// STATE
// ============================================================
let currentUser = null;
let currentFilter = {};
let activeFilterType = '';
let searchQuery = '';
let newPostType = 'info';
let uploadedFiles = [];
let currentPage = 'feed';
let searchTimer = null;
let realtimeChannel = null;

// ============================================================
// BOOT
// ============================================================
window.onload = async () => {
  initSupabase('https://sjvmdrgflfdlgkajaejr.supabase.co
', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqdm1kcmdmbGZkbGdrYWphZWpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjcyMzksImV4cCI6MjA4NzI0MzIzOX0.Qt9qmEPc9PrEdV1vPR5LsaDe6fSpP6wQKlvBw4FNUb0');
  await checkSession();
};
async function checkSession() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    const { data: profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
    currentUser = profile || { id: session.user.id, username: session.user.email };
    initApp();
  } else {
    document.getElementById('auth-screen').style.display = 'flex';
  }
}

function initApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  
  const initials = (currentUser.display_name || currentUser.username || '?').slice(0,2).toUpperCase();
  const av = document.getElementById('user-avatar');
  av.textContent = initials;
  av.style.background = getAvatarColor(currentUser.username);

  const savedFilter = JSON.parse(localStorage.getItem('yanar_filter_' + currentUser.id) || '{}');
  currentFilter = savedFilter;

  renderFilterChips();
  loadFeed();
  loadSidebarStats();
  subscribeRealtime();
  prefillAudienceFromProfile();
}

// ============================================================
// AUTH
// ============================================================
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t, i) => t.classList.toggle('active', (tab === 'login') === (i === 0)));
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
}

async function doLogin() {
  const username = document.getElementById('login-username').value.trim().toLowerCase();
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  const btn = document.getElementById('login-btn');
  errEl.textContent = '';
  if (!username || !password) { errEl.textContent = 'Fill in all fields'; return; }
  btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';

  // Look up email by username
  const { data: profile, error: pe } = await supabase.from('profiles').select('email').eq('username', username).single();
  if (pe || !profile) { errEl.textContent = 'Username not found'; btn.disabled=false; btn.textContent='Sign In'; return; }

  const { error } = await supabase.auth.signInWithPassword({ email: profile.email, password });
  if (error) { errEl.textContent = error.message; btn.disabled=false; btn.textContent='Sign In'; return; }
  await checkSession();
}

async function doRegister() {
  const username = document.getElementById('reg-username').value.trim().toLowerCase();
  const name = document.getElementById('reg-name').value.trim();
  const password = document.getElementById('reg-password').value;
  const university = document.getElementById('reg-university').value;
  const college = document.getElementById('reg-college').value;
  const branch = document.getElementById('reg-branch').value;
  const year = document.getElementById('reg-year').value;
  const errEl = document.getElementById('reg-error');
  const btn = document.getElementById('reg-btn');
  errEl.textContent = '';

  if (!username || !password) { errEl.textContent = 'Username and password are required'; return; }
  if (username.length < 3) { errEl.textContent = 'Username must be 3+ characters'; return; }
  if (!/^[a-z0-9_]+$/.test(username)) { errEl.textContent = 'Username: only letters, numbers, underscores'; return; }
  if (password.length < 6) { errEl.textContent = 'Password must be 6+ characters'; return; }

  btn.disabled = true; btn.textContent = 'Creating account‚Ä¶';

  // Check username taken
  const { data: existing } = await supabase.from('profiles').select('id').eq('username', username).single();
  if (existing) { errEl.textContent = 'Username already taken'; btn.disabled=false; btn.textContent='Create Account'; return; }

  const fakeEmail = `${username}@yanar.app`;
  const { data: authData, error: authErr } = await supabase.auth.signUp({ email: fakeEmail, password });
  if (authErr) { errEl.textContent = authErr.message; btn.disabled=false; btn.textContent='Create Account'; return; }

  const { error: profileErr } = await supabase.from('profiles').upsert({
    id: authData.user.id, username, email: fakeEmail,
    display_name: name || username, university, college, branch, year,
    created_at: new Date().toISOString()
  });
  if (profileErr) { errEl.textContent = profileErr.message; btn.disabled=false; btn.textContent='Create Account'; return; }

  await checkSession();
}

async function doLogout() {
  await supabase.auth.signOut();
  currentUser = null;
  if (realtimeChannel) supabase.removeChannel(realtimeChannel);
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
}

// ============================================================
// FEED
// ============================================================
async function loadFeed() {
  document.getElementById('feed-container').innerHTML = '<div class="loading"><div class="spinner"></div> Loading‚Ä¶</div>';
  
  let query = supabase.from('posts')
    .select(`*, profiles(username, display_name, college, university, branch), likes(user_id), comments(id)`)
    .order('created_at', { ascending: false })
    .limit(50);

  if (activeFilterType) query = query.eq('type', activeFilterType);
  if (searchQuery) query = query.or(`title.ilike.%${searchQuery}%,body.ilike.%${searchQuery}%`);

  // Academic filter
  if (currentFilter.university) query = query.or(`target_university.eq.${currentFilter.university},target_university.is.null`);
  if (currentFilter.college) query = query.or(`target_college.eq.${currentFilter.college},target_college.is.null`);
  if (currentFilter.branch) query = query.or(`target_branch.eq.${currentFilter.branch},target_branch.is.null`);
  if (currentFilter.year) query = query.or(`target_year.eq.${currentFilter.year},target_year.is.null`);

  const { data: posts, error } = await query;
  if (error) { document.getElementById('feed-container').innerHTML = `<div class="empty-state"><h3>Error loading posts</h3><p>${error.message}</p></div>`; return; }

  renderFeedPosts(posts || []);
  loadSidebarStats();
}

function renderFeedPosts(posts) {
  const container = document.getElementById('feed-container');
  if (!posts.length) {
    container.innerHTML = `<div class="empty-state"><h3>No posts yet</h3><p>Be the first to share something with your peers! üéì</p></div>`;
    return;
  }
  container.innerHTML = posts.map(p => renderPostCard(p)).join('');
}

function renderPostCard(p) {
  const profile = p.profiles || {};
  const authorName = profile.display_name || profile.username || 'Unknown';
  const color = getAvatarColor(profile.username || '');
  const initials = authorName.slice(0,2).toUpperCase();
  const typeLabels = { info:'Info', question:'Question', opportunity:'Opportunity', resource:'Resource' };
  const typeClasses = { info:'badge-info', question:'badge-question', opportunity:'badge-opportunity', resource:'badge-resource' };
  const likeCount = (p.likes || []).length;
  const commentCount = (p.comments || []).length;
  const liked = (p.likes || []).some(l => l.user_id === currentUser?.id);
  const timeAgo = getTimeAgo(p.created_at);

  const targetParts = [p.target_university, p.target_college, p.target_branch, p.target_year ? `Year ${p.target_year}` : ''].filter(Boolean);
  const targetHtml = targetParts.length
    ? `<div class="post-target">üì£ <span>${targetParts.join('</span> ‚Üí <span>')}</span></div>`
    : `<div class="post-target">üì£ <span>Everyone</span></div>`;

  const tags = (p.tags || []).map(t => `<span class="post-tag" onclick="searchByTag('${t}')">#${t}</span>`).join('');
  const filesHtml = (p.files || []).map(f =>
    `<div class="post-media">${f.type==='pdf'?'üìÑ':'üñºÔ∏è'} <span>${f.name}</span>${f.url?`<a href="${f.url}" target="_blank" style="margin-left:auto;color:var(--accent);font-size:.8rem">Open</a>`:''}</div>`
  ).join('');

  return `<div class="post-card" id="post-${p.id}">
    <div class="post-header">
      <div class="post-avatar" style="background:${color}">${initials}</div>
      <div class="post-meta">
        <div class="post-author">${escHtml(authorName)}</div>
        <div class="post-info">${escHtml(profile.college||'')}${profile.branch?' ¬∑ '+profile.branch:''} ¬∑ ${timeAgo}</div>
      </div>
      <span class="post-badge ${typeClasses[p.type]||'badge-info'}">${typeLabels[p.type]||p.type}</span>
    </div>
    ${targetHtml}
    ${p.title ? `<div class="post-title">${escHtml(p.title)}</div>` : ''}
    <div class="post-body">${escHtml(p.body||'')}</div>
    ${tags ? `<div class="post-tags">${tags}</div>` : ''}
    ${filesHtml}
    <div class="post-actions">
      <button class="post-action ${liked?'liked':''}" onclick="toggleLike('${p.id}', ${liked})">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="${liked?'currentColor':'none'}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        <span id="like-count-${p.id}">${likeCount}</span>
      </button>
      <button class="post-action" onclick="toggleComments('${p.id}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <span id="comment-count-${p.id}">${commentCount}</span>
      </button>
      <button class="post-action" onclick="copyLink('${p.id}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        Share
      </button>
    </div>
    <div id="comments-section-${p.id}" style="display:none">
      <div class="comments-section" id="comments-list-${p.id}"><div class="loading"><div class="spinner"></div></div></div>
      <div class="comment-input-row" style="margin-top:12px">
        <div class="post-avatar" style="background:${getAvatarColor(currentUser?.username)};width:30px;height:30px;font-size:.72rem;flex-shrink:0">${(currentUser?.display_name||'?').slice(0,2).toUpperCase()}</div>
        <input type="text" placeholder="Write a comment‚Ä¶" id="comment-input-${p.id}" onkeydown="if(event.key==='Enter')submitComment('${p.id}')"/>
        <button class="comment-send" onclick="submitComment('${p.id}')">Post</button>
      </div>
    </div>
  </div>`;
}

// ============================================================
// LIKES
// ============================================================
async function toggleLike(postId, currentlyLiked) {
  if (!currentUser) return;
  const countEl = document.getElementById('like-count-' + postId);
  const btn = countEl?.parentElement;

  if (currentlyLiked) {
    await supabase.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    if (countEl) countEl.textContent = parseInt(countEl.textContent) - 1;
    btn?.classList.remove('liked');
    if (btn) btn.querySelector('svg').setAttribute('fill', 'none');
  } else {
    await supabase.from('likes').insert({ post_id: postId, user_id: currentUser.id });
    if (countEl) countEl.textContent = parseInt(countEl.textContent) + 1;
    btn?.classList.add('liked');
    if (btn) btn.querySelector('svg').setAttribute('fill', 'currentColor');
  }
  // Toggle the onclick
  if (btn) btn.setAttribute('onclick', `toggleLike('${postId}', ${!currentlyLiked})`);
}

// ============================================================
// COMMENTS
// ============================================================
async function toggleComments(postId) {
  const section = document.getElementById('comments-section-' + postId);
  if (!section) return;
  if (section.style.display === 'none') {
    section.style.display = 'block';
    await loadComments(postId);
  } else {
    section.style.display = 'none';
  }
}

async function loadComments(postId) {
  const listEl = document.getElementById('comments-list-' + postId);
  if (!listEl) return;
  const { data: comments } = await supabase.from('comments')
    .select('*, profiles(username, display_name), comment_likes(user_id)')
    .eq('post_id', postId)
    .is('parent_id', null)
    .order('created_at', { ascending: true });

  const topLevel = comments || [];
  // Load replies
  if (topLevel.length === 0) { listEl.innerHTML = '<p style="color:var(--text3);font-size:.82rem;padding:8px 0">No comments yet. Be the first!</p>'; return; }

  const { data: replies } = await supabase.from('comments')
    .select('*, profiles(username, display_name), comment_likes(user_id)')
    .eq('post_id', postId).not('parent_id', 'is', null).order('created_at', { ascending: true });

  listEl.innerHTML = topLevel.map(c => renderComment(c, replies || [], postId)).join('');
}

function renderComment(c, allReplies, postId) {
  const profile = c.profiles || {};
  const name = profile.display_name || profile.username || 'User';
  const color = getAvatarColor(profile.username || '');
  const likeCount = (c.comment_likes || []).length;
  const liked = (c.comment_likes || []).some(l => l.user_id === currentUser?.id);
  const childReplies = allReplies.filter(r => r.parent_id === c.id);

  return `<div class="comment" id="comment-${c.id}">
    <div class="comment-avatar" style="background:${color}">${name.slice(0,2).toUpperCase()}</div>
    <div class="comment-content">
      <span class="comment-author">${escHtml(name)}</span>
      <div class="comment-text">${escHtml(c.body)}</div>
      <div class="comment-actions">
        <button class="comment-action" onclick="toggleCommentLike('${c.id}','${postId}',${liked})">‚ù§Ô∏è ${likeCount}</button>
        <button class="comment-action" onclick="toggleReplyInput('${c.id}','${postId}')">Reply</button>
      </div>
      ${childReplies.length ? `<div class="nested-comments">${childReplies.map(r => renderComment(r, [], postId)).join('')}</div>` : ''}
      <div id="reply-input-${c.id}" style="display:none">
        <div class="comment-input-row" style="margin-top:8px">
          <input type="text" placeholder="Reply‚Ä¶" id="reply-text-${c.id}" onkeydown="if(event.key==='Enter')submitReply('${postId}','${c.id}')"/>
          <button class="comment-send" onclick="submitReply('${postId}','${c.id}')">Reply</button>
        </div>
      </div>
    </div>
  </div>`;
}

function toggleReplyInput(commentId, postId) {
  const el = document.getElementById('reply-input-' + commentId);
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

async function submitComment(postId) {
  const input = document.getElementById('comment-input-' + postId);
  const body = input?.value?.trim();
  if (!body || !currentUser) return;
  input.value = '';
  await supabase.from('comments').insert({ post_id: postId, user_id: currentUser.id, body, parent_id: null });
  await loadComments(postId);
  // Update count
  const countEl = document.getElementById('comment-count-' + postId);
  if (countEl) countEl.textContent = parseInt(countEl.textContent) + 1;
  showToast('Comment posted!');
}

async function submitReply(postId, parentId) {
  const input = document.getElementById('reply-text-' + parentId);
  const body = input?.value?.trim();
  if (!body || !currentUser) return;
  input.value = '';
  await supabase.from('comments').insert({ post_id: postId, user_id: currentUser.id, body, parent_id: parentId });
  await loadComments(postId);
  showToast('Reply posted!');
}

async function toggleCommentLike(commentId, postId, currentlyLiked) {
  if (!currentUser) return;
  if (currentlyLiked) {
    await supabase.from('comment_likes').delete().eq('comment_id', commentId).eq('user_id', currentUser.id);
  } else {
    await supabase.from('comment_likes').insert({ comment_id: commentId, user_id: currentUser.id });
  }
  await loadComments(postId);
}

// ============================================================
// CREATE POST
// ============================================================
function showCreateModal() {
  document.getElementById('create-modal').style.display = 'flex';
  uploadedFiles = [];
  document.getElementById('uploaded-files').innerHTML = '';
  document.getElementById('create-title').value = '';
  document.getElementById('create-body').value = '';
  document.getElementById('title-chars').textContent = '0';
  document.getElementById('body-chars').textContent = '0';
  prefillAudienceFromProfile();
}
function closeCreateModal() { document.getElementById('create-modal').style.display = 'none'; }

function setPostType(type) {
  newPostType = type;
  const classes = { info:'active-i', question:'active-q', opportunity:'active-o', resource:'active-r' };
  ['info','question','opportunity','resource'].forEach(t => {
    const btn = document.getElementById('type-' + t);
    btn.className = 'type-btn' + (t === type ? ' ' + classes[t] : '');
  });
}

async function handleFileUpload(event) {
  const files = Array.from(event.target.files);
  for (const file of files) {
    if (file.size > 5 * 1024 * 1024) { showToast(`${file.name} is too large (max 5MB)`); continue; }
    const ext = file.name.split('.').pop();
    const path = `uploads/${currentUser.id}/${Date.now()}_${file.name}`;
    const { data, error } = await supabase.storage.from('yanar-files').upload(path, file);
    if (error) { showToast('Upload failed: ' + error.message); continue; }
    const { data: { publicUrl } } = supabase.storage.from('yanar-files').getPublicUrl(path);
    uploadedFiles.push({ name: file.name, type: file.type.includes('pdf') ? 'pdf' : 'image', url: publicUrl });
    renderUploadedFiles();
    showToast(`${file.name} uploaded ‚úì`);
  }
}

function renderUploadedFiles() {
  document.getElementById('uploaded-files').innerHTML = uploadedFiles.map((f, i) =>
    `<div style="display:flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:.8rem;color:var(--text2)">
      ${f.type==='pdf'?'üìÑ':'üñºÔ∏è'} ${escHtml(f.name)}
      <button onclick="uploadedFiles.splice(${i},1);renderUploadedFiles()" style="background:none;border:none;color:var(--text3);cursor:pointer;margin-left:4px">‚úï</button>
    </div>`
  ).join('');
}

function prefillAudienceFromProfile() {
  if (!currentUser) return;
  const au = document.getElementById('aud-university');
  if (au) { au.value = currentUser.university || ''; audUpdateColleges(); }
  setTimeout(() => {
    const ac = document.getElementById('aud-college');
    if (ac) { ac.value = currentUser.college || ''; audUpdateBranches(); }
    setTimeout(() => {
      const ab = document.getElementById('aud-branch');
      if (ab) ab.value = '';  // default all branches
    }, 50);
  }, 50);
}

async function submitPost() {
  const title = document.getElementById('create-title').value.trim();
  const body = document.getElementById('create-body').value.trim();
  if (!title && !body) { showToast('Please add some content!'); return; }

  const btn = document.getElementById('submit-post-btn');
  btn.disabled = true; btn.textContent = 'Publishing‚Ä¶';

  const tags = extractTags(title + ' ' + body);

  const { error } = await supabase.from('posts').insert({
    user_id: currentUser.id,
    type: newPostType,
    title: title || null,
    body: body || null,
    tags,
    files: uploadedFiles,
    target_university: document.getElementById('aud-university').value || null,
    target_college: document.getElementById('aud-college').value || null,
    target_branch: document.getElementById('aud-branch').value || null,
    target_year: document.getElementById('aud-year').value || null,
    created_at: new Date().toISOString()
  });

  btn.disabled = false; btn.textContent = 'Publish Post üöÄ';
  if (error) { showToast('Error: ' + error.message); return; }

  closeCreateModal();
  showToast('Post published! üéâ');
  showPage('feed');
  loadFeed();
}

// ============================================================
// FILTER
// ============================================================
function showFilterModal() {
  document.getElementById('filter-modal').style.display = 'flex';
  document.getElementById('filter-university').value = currentFilter.university || '';
  updateCollegeOptions();
  setTimeout(() => {
    document.getElementById('filter-college').value = currentFilter.college || '';
    updateBranchOptions();
    setTimeout(() => {
      document.getElementById('filter-branch').value = currentFilter.branch || '';
      document.getElementById('filter-year').value = currentFilter.year || '';
    }, 50);
  }, 50);
  renderSavedCombos();
}
function closeFilterModal() { document.getElementById('filter-modal').style.display = 'none'; }

function applyFilter() {
  currentFilter = {
    university: document.getElementById('filter-university').value,
    college: document.getElementById('filter-college').value,
    branch: document.getElementById('filter-branch').value,
    year: document.getElementById('filter-year').value
  };
  localStorage.setItem('yanar_filter_' + currentUser.id, JSON.stringify(currentFilter));
  closeFilterModal();
  renderFilterChips();
  loadFeed();
}

function clearFilter() {
  currentFilter = {};
  localStorage.removeItem('yanar_filter_' + currentUser.id);
  ['filter-university','filter-college','filter-branch','filter-year'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
  closeFilterModal();
  renderFilterChips();
  loadFeed();
}

function renderFilterChips() {
  const chips = [currentFilter.university, currentFilter.college, currentFilter.branch, currentFilter.year ? `Year ${currentFilter.year}` : ''].filter(Boolean);
  document.getElementById('active-filter-chips').innerHTML = chips.map(c => `<span class="filter-chip">üìå ${escHtml(c)}</span>`).join('');
}

// Saved combos
function getSavedCombos() { try { return JSON.parse(localStorage.getItem('yanar_combos_' + currentUser?.id) || '[]'); } catch { return []; } }
function saveCurrentCombo() {
  const u = document.getElementById('filter-university').value;
  if (!u) { showToast('Select at least a university first'); return; }
  const combo = {
    label: [u, document.getElementById('filter-college').value, document.getElementById('filter-branch').value, document.getElementById('filter-year').value ? `Year ${document.getElementById('filter-year').value}` : ''].filter(Boolean).join(' ‚Ä∫ '),
    university: u, college: document.getElementById('filter-college').value,
    branch: document.getElementById('filter-branch').value, year: document.getElementById('filter-year').value
  };
  const combos = getSavedCombos();
  combos.push(combo);
  localStorage.setItem('yanar_combos_' + currentUser.id, JSON.stringify(combos));
  renderSavedCombos();
  showToast('Combination pinned! üìå');
}

function renderSavedCombos() {
  const combos = getSavedCombos();
  const container = document.getElementById('saved-combos-list');
  if (!combos.length) { container.innerHTML = '<p style="font-size:.8rem;color:var(--text3);margin-bottom:8px">No pinned combinations yet</p>'; return; }
  container.innerHTML = combos.map((c, i) => `
    <div class="saved-combo-item" onclick="applySavedCombo(${i})">
      <span style="font-size:.85rem">üìå ${escHtml(c.label)}</span>
      <button onclick="event.stopPropagation();deleteSavedCombo(${i})" style="background:none;border:none;color:var(--text3);cursor:pointer">‚úï</button>
    </div>`).join('');
}

function applySavedCombo(i) {
  const c = getSavedCombos()[i];
  if (!c) return;
  document.getElementById('filter-university').value = c.university || '';
  updateCollegeOptions();
  setTimeout(() => {
    document.getElementById('filter-college').value = c.college || '';
    updateBranchOptions();
    setTimeout(() => {
      document.getElementById('filter-branch').value = c.branch || '';
      document.getElementById('filter-year').value = c.year || '';
    }, 50);
  }, 50);
}

function deleteSavedCombo(i) {
  const combos = getSavedCombos(); combos.splice(i, 1);
  localStorage.setItem('yanar_combos_' + currentUser.id, JSON.stringify(combos));
  renderSavedCombos();
}

// ============================================================
// PAGES & NAV
// ============================================================
function showPage(page) {
  currentPage = page;
  const mainLayout = document.querySelector('.main-layout');
  const profilePage = document.getElementById('profile-page');
  if (page === 'feed') {
    mainLayout.style.display = 'flex'; profilePage.style.display = 'none';
    activeFilterType = '';
    document.getElementById('nav-feed').classList.add('active');
    ['nav-questions','nav-opportunities','nav-profile'].forEach(id => document.getElementById(id)?.classList.remove('active'));
    loadFeed();
  } else if (page === 'profile') {
    mainLayout.style.display = 'none'; profilePage.style.display = 'block';
    document.getElementById('nav-profile').classList.add('active');
    ['nav-feed','nav-questions','nav-opportunities'].forEach(id => document.getElementById(id)?.classList.remove('active'));
    loadProfilePage();
  }
}

function filterByType(type) {
  activeFilterType = activeFilterType === type ? '' : type;
  showPage('feed');
  const navMap = { question:'nav-questions', opportunity:'nav-opportunities' };
  ['nav-feed','nav-questions','nav-opportunities'].forEach(id => document.getElementById(id)?.classList.remove('active'));
  if (activeFilterType && navMap[activeFilterType]) document.getElementById(navMap[activeFilterType])?.classList.add('active');
  else document.getElementById('nav-feed')?.classList.add('active');
}

async function loadProfilePage() {
  const initials = (currentUser.display_name || currentUser.username || '?').slice(0,2).toUpperCase();
  const bigAv = document.getElementById('profile-avatar-big');
  bigAv.textContent = initials; bigAv.style.background = getAvatarColor(currentUser.username);
  document.getElementById('profile-username-display').textContent = currentUser.display_name || currentUser.username;
  document.getElementById('profile-college-display').textContent = [currentUser.college, currentUser.branch, currentUser.year ? `Year ${currentUser.year}` : ''].filter(Boolean).join(' ¬∑ ') || 'No college info';

  const { data: posts } = await supabase.from('posts').select('*, likes(user_id), comments(id)').eq('user_id', currentUser.id).order('created_at', { ascending: false });
  const myPosts = posts || [];
  const totalLikes = myPosts.reduce((s, p) => s + (p.likes || []).length, 0);
  const { count: commentCount } = await supabase.from('comments').select('id', { count: 'exact', head: true }).eq('user_id', currentUser.id);

  document.getElementById('ps-posts').textContent = myPosts.length;
  document.getElementById('ps-comments').textContent = commentCount || 0;
  document.getElementById('ps-likes').textContent = totalLikes;

  const container = document.getElementById('profile-posts');
  container.innerHTML = myPosts.length ? myPosts.map(p => renderPostCard(p)).join('') : '<div class="empty-state"><h3>No posts yet</h3><p>Start sharing with your peers!</p></div>';
}

async function loadSidebarStats() {
  if (!currentUser) return;
  const { data: posts } = await supabase.from('posts').select('likes(user_id), comments(id)').eq('user_id', currentUser.id);
  const myPosts = posts || [];
  document.getElementById('stat-posts').textContent = myPosts.length;
  document.getElementById('stat-likes').textContent = myPosts.reduce((s, p) => s + (p.likes || []).length, 0);

  const { count } = await supabase.from('comments').select('id', { count: 'exact', head: true }).eq('user_id', currentUser.id);
  document.getElementById('stat-comments').textContent = count || 0;

  // Trending tags
  const { data: allPosts } = await supabase.from('posts').select('tags').limit(100);
  const tagCount = {};
  (allPosts || []).forEach(p => (p.tags || []).forEach(t => { tagCount[t] = (tagCount[t] || 0) + 1; }));
  const topTags = Object.entries(tagCount).sort((a, b) => b[1] - a[1]).slice(0, 12);
  document.getElementById('trending-tags').innerHTML = topTags.map(([t]) => `<span class="post-tag" onclick="searchByTag('${t}')">#${t}</span>`).join('');
}

// ============================================================
// REAL-TIME
// ============================================================
function subscribeRealtime() {
  realtimeChannel = supabase.channel('public:posts')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, () => {
      if (currentPage === 'feed') loadFeed();
    }).subscribe();
}

// ============================================================
// SEARCH
// ============================================================
function debounceSearch(val) {
  clearTimeout(searchTimer);
  searchQuery = val;
  searchTimer = setTimeout(() => loadFeed(), 400);
}
function searchByTag(tag) {
  document.getElementById('search-input').value = tag;
  searchQuery = tag;
  showPage('feed');
}

// ============================================================
// DROPDOWN HELPERS
// ============================================================
function fillCollegeSelect(selId, university) {
  const sel = document.getElementById(selId);
  if (!sel) return;
  sel.innerHTML = '<option value="">All Colleges</option>';
  if (university && UNIVERSITIES[university]) {
    Object.keys(UNIVERSITIES[university]).forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o);
    });
  }
}
function fillBranchSelect(selId, university, college) {
  const sel = document.getElementById(selId);
  if (!sel) return;
  sel.innerHTML = '<option value="">All Branches</option>';
  if (university && college && UNIVERSITIES[university]?.[college]) {
    (UNIVERSITIES[university][college].branches || []).forEach(b => {
      const o = document.createElement('option'); o.value = b; o.textContent = b; sel.appendChild(o);
    });
  }
}

function updateCollegeOptions() { fillCollegeSelect('filter-college', document.getElementById('filter-university').value); document.getElementById('filter-branch').innerHTML='<option value="">All Branches</option>'; }
function updateBranchOptions() { fillBranchSelect('filter-branch', document.getElementById('filter-university').value, document.getElementById('filter-college').value); }
function regUpdateColleges() { fillCollegeSelect('reg-college', document.getElementById('reg-university').value); document.getElementById('reg-branch').innerHTML='<option value="">Select Branch</option>'; }
function regUpdateBranches() { fillBranchSelect('reg-branch', document.getElementById('reg-university').value, document.getElementById('reg-college').value); }
function audUpdateColleges() { fillCollegeSelect('aud-college', document.getElementById('aud-university').value); document.getElementById('aud-branch').innerHTML='<option value="">All Branches</option>'; }
function audUpdateBranches() { fillBranchSelect('aud-branch', document.getElementById('aud-university').value, document.getElementById('aud-college').value); }

// ============================================================
// UTILS
// ============================================================
function getAvatarColor(str = '') {
  const colors = ['#6c63ff','#ff6584','#43e97b','#f7971e','#4ecdc4','#a855f7','#f59e0b','#3b82f6'];
  let h = 0; for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) % colors.length;
  return colors[h];
}
function getTimeAgo(ts) {
  const s = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return `${Math.floor(s/60)}m ago`;
  if (s < 86400) return `${Math.floor(s/3600)}h ago`;
  return `${Math.floor(s/86400)}d ago`;
}
function escHtml(t) { return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
function extractTags(text) {
  const words = text.toLowerCase().match(/\b[a-z]{3,}\b/g) || [];
  const stop = ['the','and','for','that','this','with','from','have','been','they','your','will'];
  return [...new Set(words.filter(w => !stop.includes(w)))].slice(0, 6);
}
function showToast(msg) {
  const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
function copyLink(postId) {
  navigator.clipboard?.writeText(window.location.href + '#post-' + postId).then(() => showToast('Link copied!'));
}
</script>

<!-- SERVICE WORKER -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
